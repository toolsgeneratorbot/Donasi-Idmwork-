<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Aplikasi pengecekan harga produk Indomaret berbasis PLU dan barcode">
  <meta name="author" content="ToolsGenerator">
  <title>ToolsGenerator - Retail Solutions</title>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SPV69B3KT6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-SPV69B3KT6');
  </script>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Leaflet CSS for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root {
      --primary: #00e0ff;
      --primary-dark: #00a8cc;
      --accent: #00c2ff;
      --bg: #10131a;
      --card-bg: #181b20;
      --text: #e8f9ff;
      --text-muted: #9ea9b8;
      --error: #ff4d4d;
      --success: #28a745;
      --promo: #ff6b6b;
      --shadow: 0 8px 32px #00e0ff22;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #10131a 70%, #00e0ff11 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .main {
      padding: 1.5rem;
      flex-grow: 1;
      min-height: 100vh;
      background: none;
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      background: linear-gradient(90deg, #00e0ff22 0%, #181b20 100%);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 1.2rem 1.5rem;
    }
    .header h1 {
      font-size: 1.8rem;
      color: var(--primary);
      font-weight: 700;
      letter-spacing: 1px;
    }
    #clock {
      font-size: 1rem;
      color: var(--accent);
      background: rgba(0, 194, 255, 0.13);
      padding: 0.5rem 1rem;
      border-radius: 18px;
      font-family: 'Courier New', monospace;
      font-weight: 600;
      box-shadow: 0 2px 8px #00e0ff22;
    }
    
    /* Search Section */
    .search-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
    }
    .search-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .search-container {
      display: flex;
      gap: 10px;
    }
    .search-input {
      flex: 1;
      background: #23262c;
      border: 1.5px solid #23262c;
      color: var(--text);
      border-radius: 12px;
      padding: 1rem;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px #00e0ff33;
      outline: none;
    }
    .search-btn {
      background: linear-gradient(90deg, #00e0ff 0%, #00c2ff 100%);
      color: #181b20;
      border: none;
      border-radius: 12px;
      padding: 0 1.5rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 8px #00e0ff22;
      transition: all 0.2s;
    }
    .search-btn:hover {
      background: linear-gradient(90deg, #00c2ff 0%, #00e0ff 100%);
      box-shadow: 0 4px 12px #00e0ff33;
    }
    .scan-btn {
      background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0 1.2rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.22);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .scan-btn:hover {
      background: linear-gradient(90deg, #20c997 0%, #28a745 100%);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.33);
    }
    
    /* Scanner Section */
    .scanner-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
      display: none;
    }
    .scanner-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #reader {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }
    .scanner-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 1rem;
    }
    .scanner-btn {
      padding: 0.8rem 1.5rem;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .scanner-btn-primary {
      background: linear-gradient(90deg, #00e0ff 0%, #00c2ff 100%);
      color: #181b20;
    }
    .scanner-btn-danger {
      background: linear-gradient(90deg, #ff4d4d 0%, #ff6b6b 100%);
      color: white;
    }
    
    /* Products List */
    .products-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .product-item {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 1.2rem;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.2s;
    }
    .product-item:hover {
      box-shadow: 0 8px 24px #00e0ff33;
      transform: translateY(-2px);
    }
    .product-name {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }
    .product-prices {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .product-price-normal {
      font-size: 1rem;
      color: var(--text-muted);
      text-decoration: line-through;
    }
    .product-price-promo {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--promo);
    }
    .product-price-only {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary);
    }
    .product-plu {
      font-size: 0.9rem;
      color: var(--text-muted);
      font-family: 'Courier New', monospace;
    }
    
    /* No Products Message */
    .no-products {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      font-style: italic;
    }
    
    /* Loading Products */
    .loading-products {
      text-align: center;
      padding: 2rem;
      color: var(--primary);
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 224, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Product Detail Modal */
    .product-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .product-modal.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: var(--card-bg);
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      padding: 2rem;
      box-shadow: 0 20px 60px rgba(0, 224, 255, 0.25);
      position: relative;
      transform: translateY(20px);
      transition: transform 0.3s;
      max-height: 90vh;
      overflow-y: auto;
    }
    .product-modal.active .modal-content {
      transform: translateY(0);
    }
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.2s;
    }
    .modal-close:hover {
      color: var(--primary);
    }
    .modal-product-image {
      width: 100%;
      max-width: 220px;
      height: 220px;
      border-radius: 12px;
      object-fit: contain;
      margin: 0 auto 1.5rem;
      display: block;
      background: #fff;
      padding: 10px;
    }
    .modal-product-name {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: var(--primary);
      text-align: center;
    }
    .modal-product-prices {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 1.5rem;
    }
    .modal-product-desc {
      font-size: 1rem;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 1.5rem;
      font-style: italic;
    }
    .modal-barcode {
      background: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: center;
    }
    .modal-plu {
      text-align: center;
      font-family: 'Courier New', monospace;
      color: var(--text-muted);
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    .modal-barcode-number {
      text-align: center;
      font-family: 'Courier New', monospace;
      color: var(--text);
      font-size: 1rem;
    }
    
    footer {
      margin-top: 2.5rem;
      font-size: 0.9rem;
      color: var(--text-muted);
      padding: 1.5rem 0;
      text-align: center;
      border-top: 1px solid #23262c;
    }
    
    /* Hacker Loading Animation */
    .hacker-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-family: 'Courier New', monospace;
      color: #00ff00;
      overflow: hidden;
    }
    
    .hacker-text {
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: 2rem;
      text-shadow: 0 0 5px #00ff00;
    }
    
    .binary-rain {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    .binary-digit {
      position: absolute;
      color: #00ff00;
      font-size: 14px;
      opacity: 0.7;
      animation: fallDown linear infinite;
    }
    
    @keyframes fallDown {
      0% {
        transform: translateY(-100%);
        opacity: 0;
      }
      5% {
        opacity: 1;
      }
      95% {
        opacity: 0.8;
      }
      100% {
        transform: translateY(1000%);
        opacity: 0;
      }
    }
    
    .progress-bar {
      width: 300px;
      height: 20px;
      background: #000;
      border: 1px solid #00ff00;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 20px;
    }
    
    .progress {
      height: 100%;
      width: 0%;
      background: #00ff00;
      transition: width 0.3s;
    }
    
    /* Tab Menu */
    .tab-menu {
      display: flex;
      gap: 12px;
      margin-bottom: 1.5rem;
    }
    .tab-btn {
      background: var(--card-bg);
      color: var(--primary);
      border: 1.5px solid var(--primary);
      border-radius: 12px;
      padding: 0.7rem 1.5rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: var(--primary);
      color: var(--card-bg);
    }
    /* Maps Section */
    .maps-section {
      display: none;
      background: var(--card-bg);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
    }
    #map {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      margin-bottom: 1rem;
    }
    .maps-search-container {
      display: flex;
      gap: 10px;
      margin-bottom: 1rem;
    }
    .maps-search-input {
      flex: 1;
      background: #23262c;
      border: 1.5px solid #23262c;
      color: var(--text);
      border-radius: 12px;
      padding: 0.8rem;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .maps-search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px #00e0ff33;
      outline: none;
    }
    .maps-search-btn {
      background: linear-gradient(90deg, #00e0ff 0%, #00c2ff 100%);
      color: #181b20;
      border: none;
      border-radius: 12px;
      padding: 0 1.2rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 8px #00e0ff22;
      transition: all 0.2s;
    }
    .maps-list {
      margin-top: 1rem;
      max-height: 220px;
      overflow-y: auto;
      font-size: 0.98rem;
    }
    .maps-list-item {
      padding: 0.7rem 0.5rem;
      border-bottom: 1px solid #23262c;
      cursor: pointer;
      transition: background 0.2s;
    }
    .maps-list-item:hover {
      background: #23262c;
    }
    
    @media (max-width: 768px) {
      .main { padding: 1rem; }
      .header { padding: 1rem; }
      .header h1 { font-size: 1.4rem; }
      .search-section { padding: 1.2rem; }
      .search-container { flex-direction: column; }
      .scan-btn { justify-content: center; padding: 1rem; }
      .modal-content { width: 95%; padding: 1.5rem; }
    }
    
    @media (max-width: 480px) {
      .main { padding: 0.8rem; }
      .header { flex-direction: column; gap: 10px; text-align: center; }
      .header h1 { font-size: 1.3rem; }
      .modal-content { padding: 1.2rem; }
      .modal-product-image { max-width: 180px; height: 180px; }
    }
  </style>
</head>
<body>
  <!-- Hacker Loading Screen -->
  <div id="hackerLoading" class="hacker-loading">
    <div class="binary-rain" id="binaryRain"></div>
    <div class="hacker-text">TOOLSGENERATOR SYSTEM INITIALIZING...</div>
    <div class="progress-bar">
      <div class="progress" id="loadingProgress"></div>
    </div>
  </div>

  <div class="main">
    <header class="header">
      <h1>Cari Produk KlikIndomaret</h1>
      <div id="clock">--:--:--</div>
    </header>

    <!-- Tab Menu -->
    <div class="tab-menu">
      <button class="tab-btn active" id="produkTabBtn"><i class="fas fa-box"></i> Produk</button>
      <button class="tab-btn" id="mapsTabBtn"><i class="fas fa-map-marker-alt"></i> Maps Toko</button>
    </div>

    <!-- Produk Section -->
    <div id="produkSection">
      <div class="search-section">
        <div class="search-title">
          <i class="fas fa-search"></i>
          Cari Produk
        </div>
        <div class="search-container">
          <input type="text" class="search-input" id="searchInput" placeholder="Nama / PLU / Barcode...">
          <button class="search-btn" id="searchBtn">Cari</button>
          <button class="scan-btn" id="scanBtn">
            <i class="fas fa-camera"></i> Scan
          </button>
        </div>
      </div>
      <div class="scanner-section" id="scannerSection">
        <div class="scanner-title">
          <i class="fas fa-camera"></i>
          Scan Barcode
        </div>
        <div id="reader"></div>
        <div class="scanner-actions">
          <select id="cameraSelect" style="padding:0.5rem 1rem;border-radius:8px;background:#23262c;color:var(--text);border:none;font-weight:600;"></select>
          <button class="scanner-btn scanner-btn-primary" id="switchCameraBtn">Switch Camera</button>
          <button class="scanner-btn scanner-btn-danger" id="stopScannerBtn">Stop Scan</button>
        </div>
      </div>
      <div class="products-list" id="productsList">
        <div class="loading-products">
          <span class="loading-spinner"></span> Gunakan kolom pencarian untuk mencari produk
        </div>
      </div>
    </div>

    <!-- Maps Section -->
    <div class="maps-section" id="mapsSection">
      <div class="search-title">
        <i class="fas fa-map-marker-alt"></i>
        Maps Toko Indomaret
      </div>
      <div class="maps-search-container">
        <input type="text" class="maps-search-input" id="mapsSearchInput" placeholder="StoreCode / Nama Toko / Alamat...">
        <button class="maps-search-btn" id="mapsSearchBtn">Cari Toko</button>
      </div>
      <div id="map"></div>
      <div class="maps-list" id="mapsList"></div>
    </div>

    <footer>
      &copy; <span id="currentYear"></span> ToolsGenerator | Retail Solutions<br>
      Versi 1.0.0
    </footer>
  </div>
  
  <!-- Product Detail Modal -->
  <div class="product-modal" id="productModal">
    <div class="modal-content">
      <button class="modal-close" id="modalClose">&times;</button>
      <img src="" alt="Gambar Produk" class="modal-product-image" id="modalProductImage">
      <h2 class="modal-product-name" id="modalProductName"></h2>
      <div class="modal-product-prices" id="modalProductPrices">
        <!-- Prices will be dynamically added here -->
      </div>
      <p class="modal-product-desc" id="modalProductDesc"></p>
      <div class="modal-barcode">
        <canvas id="modalBarcodeCanvas"></canvas>
      </div>
      <div class="modal-plu" id="modalPlu"></div>
      <div class="modal-barcode-number" id="modalBarcodeNumber"></div>
    </div>
  </div>

  <!-- Leaflet JS for maps -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Konfigurasi Aplikasi
    const APP_CONFIG = {
      appName: "ToolsGenerator",
      version: "1.0.0",
      apiSearch: "https://idmhelp.vercel.app/api/search?q="
    };
    
    // Variabel global
    let html5QrCode = null;
    let currentCameraId = null;
    let tokoDatabase = [];
    let map = null;
    let tokoMarkers = [];
    let tokoLayerGroup = null;
    
    // Inisialisasi
    document.addEventListener('DOMContentLoaded', function() {
      // Tampilkan hacker loading screen
      showHackerLoading();
      
      document.getElementById('currentYear').textContent = new Date().getFullYear();
      
      // Setup event listeners
      document.getElementById('searchBtn').addEventListener('click', searchProducts);
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchProducts();
        }
      });
      
      document.getElementById('scanBtn').addEventListener('click', startScanner);
      document.getElementById('stopScannerBtn').addEventListener('click', stopScanner);
      document.getElementById('switchCameraBtn').addEventListener('click', switchCamera);
      document.getElementById('modalClose').addEventListener('click', closeModal);
      document.getElementById('mapsTabBtn').addEventListener('click', showMapsTab);
      document.getElementById('produkTabBtn').addEventListener('click', showProdukTab);
      document.getElementById('mapsSearchBtn').addEventListener('click', searchToko);
      document.getElementById('mapsSearchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchToko();
        }
      });
      
      // Load database toko
      loadTokoDatabase();
    });
    
    // Tab switching
    function showMapsTab() {
      document.getElementById('produkSection').style.display = 'none';
      document.getElementById('mapsSection').style.display = 'block';
      document.getElementById('mapsTabBtn').classList.add('active');
      document.getElementById('produkTabBtn').classList.remove('active');
      setTimeout(() => { if (map) map.invalidateSize(); }, 300);
    }
    function showProdukTab() {
      document.getElementById('produkSection').style.display = 'block';
      document.getElementById('mapsSection').style.display = 'none';
      document.getElementById('produkTabBtn').classList.add('active');
      document.getElementById('mapsTabBtn').classList.remove('active');
    }
    // Default: produk tab
    document.getElementById('produkSection').style.display = 'block';
    document.getElementById('mapsSection').style.display = 'none';

    // Fungsi untuk memuat database toko dari file JSON
    async function loadTokoDatabase() {
      let tokoList = [];
      // Helper: fetch and parse JSON, return array or []
      async function fetchTokoFile(file) {
        try {
          // Ganti fetch ke endpoint API
          const map = {
            './database_toko_full.json': '/api/toko_full',
            './database_toko_fulll.json': '/api/toko_fulll'
          };
          const response = await fetch(map[file] || file);
          if (!response.ok) return [];
          const tokoJson = await response.json();
          return tokoJson.data && tokoJson.data.content ? tokoJson.data.content : [];
        } catch {
          return [];
        }
      }
      // Coba baca kedua file
      const tokoFull = await fetchTokoFile('./database_toko_full.json');
      const tokoFulll = await fetchTokoFile('./database_toko_fulll.json');
      tokoList = [...tokoFull, ...tokoFulll];
      tokoDatabase = tokoList;
      if (tokoDatabase.length === 0) {
        document.getElementById('mapsList').innerHTML = '<div class="no-products">Gagal memuat database toko.</div>';
        return;
      }
      initMap();
      renderTokoMarkers(tokoDatabase);
      renderTokoList(tokoDatabase);
    }

    // Fungsi untuk menampilkan hacker loading screen
    function showHackerLoading() {
      const loadingEl = document.getElementById('hackerLoading');
      const progressEl = document.getElementById('loadingProgress');
      const binaryRainEl = document.getElementById('binaryRain');
      
      // Buat efek hujan kode biner
      function createBinaryRain() {
        const chars = '01';
        for (let i = 0; i < 50; i++) {
          setTimeout(() => {
            const digit = document.createElement('div');
            digit.className = 'binary-digit';
            digit.textContent = chars.charAt(Math.floor(Math.random() * chars.length));
            digit.style.left = Math.random() * 100 + '%';
            digit.style.animationDuration = (Math.random() * 5 + 3) + 's';
            digit.style.animationDelay = (Math.random() * 2) + 's';
            binaryRainEl.appendChild(digit);
            
            // Hapus elemen setelah animasi selesai
            setTimeout(() => {
              digit.remove();
            }, 8000);
          }, i * 100);
        }
      }
      
      // Jalankan efek hujan kode biner berulang
      createBinaryRain();
      setInterval(createBinaryRain, 3000);
      
      // Simulasi progress loading
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 5;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          
          // Sembunyikan loading screen setelah selesai
          setTimeout(() => {
            loadingEl.style.opacity = '0';
            setTimeout(() => {
              loadingEl.style.display = 'none';
            }, 1000);
          }, 500);
        }
        progressEl.style.width = progress + '%';
      }, 200);
    }
    
    // Fungsi untuk mencari produk menggunakan API
    async function searchProducts() {
      const searchTerm = document.getElementById('searchInput').value.trim();
      
      if (searchTerm === '') {
        document.getElementById('productsList').innerHTML = '<div class="no-products">Gunakan kolom pencarian untuk mencari produk</div>';
        return;
      }
      
      // Tampilkan loading
      document.getElementById('productsList').innerHTML = `
        <div class="loading-products">
          <span class="loading-spinner"></span> Mencari produk...
        </div>
      `;
      
      try {
        // Panggil API untuk mencari produk
        const response = await fetch(`${APP_CONFIG.apiSearch}${encodeURIComponent(searchTerm)}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.status === "success" && data.data && data.data.length > 0) {
          displayProducts(data.data);
        } else {
          document.getElementById('productsList').innerHTML = '<div class="no-products">Tidak ada produk ditemukan</div>';
        }
      } catch (error) {
        console.error("Gagal mencari produk:", error);
        document.getElementById('productsList').innerHTML = `
          <div class="no-products">
            Gagal mencari produk. Pastikan koneksi internet Anda stabil dan coba lagi.
            <br><br>
            <button onclick="searchProducts()" style="
              background: var(--primary);
              color: var(--card-bg);
              border: none;
              padding: 10px 15px;
              border-radius: 8px;
              cursor: pointer;
              font-weight: bold;
            ">Coba Lagi</button>
          </div>
        `;
      }
    }
    
    // Fungsi untuk menampilkan daftar produk
    function displayProducts(products) {
      const productsList = document.getElementById('productsList');

      if (products.length === 0) {
        productsList.innerHTML = '<div class="no-products">Tidak ada produk ditemukan</div>';
        return;
      }

      productsList.innerHTML = '';

      products.forEach(product => {
        const productItem = document.createElement('div');
        productItem.className = 'product-item';
        productItem.addEventListener('click', () => showProductDetail(product));

        // Format harga
        const hargaNormal = product.harga_normal ? `Rp ${parseInt(product.harga_normal).toLocaleString('id-ID')}` : '';
        const hargaPromo = product.harga_promo ? `Rp ${parseInt(product.harga_promo).toLocaleString('id-ID')}` : '';
        
        // Gambar produk (default jika tidak ada)
        let imageSrc = product.image
          ? product.image
          : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjMjMyNjJjIi8+PHRleHQgeD0iMzUiIHk9IjM2IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTAiIGZpbGw9IiM5ZWE5YjgiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';

        // HTML gambar + info produk
        const productHtml = `
          <div style="display:flex;align-items:center;gap:16px;">
            <img src="${imageSrc}" alt="Gambar Produk" style="width:56px;height:56px;border-radius:8px;object-fit:contain;background:#fff;padding:4px;">
            <div style="flex:1;">
              <div class="product-name">${product.nama_produk}</div>
              <div class="product-prices">
                ${hargaNormal ? `<span class="product-price-normal">${hargaNormal}</span>` : ''}
                ${hargaPromo ? `<span class="product-price-promo">${hargaPromo}</span>` : `<span class="product-price-only">${hargaNormal || 'Harga tidak tersedia'}</span>`}
              </div>
              <div class="product-plu">PLU: ${product.plu}</div>
            </div>
          </div>
        `;

        productItem.innerHTML = productHtml;
        productsList.appendChild(productItem);
      });
    }
    
    // Fungsi untuk menampilkan detail produk
    function showProductDetail(product) {
      const modal = document.getElementById('productModal');
      const image = document.getElementById('modalProductImage');
      const name = document.getElementById('modalProductName');
      const prices = document.getElementById('modalProductPrices');
      const desc = document.getElementById('modalProductDesc');
      const plu = document.getElementById('modalPlu');
      const barcodeNumber = document.getElementById('modalBarcodeNumber');
      
      // Set data produk
      name.textContent = product.nama_produk;
      desc.textContent = product.deskripsi || "Tidak ada deskripsi tersedia";
      plu.textContent = `PLU: ${product.plu}`;
      barcodeNumber.textContent = `Barcode: ${product.barcode || "Tidak tersedia"}`;
      
      // Set gambar produk
      if (product.image) {
        image.src = product.image;
        image.onerror = function() {
          this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzIzMjYyYyIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5ZWE5YjgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjM1ZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
        };
      } else {
        image.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzIzMjYyYyIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5ZWE5YjgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjM1ZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
      }
      
      // Set harga
      prices.innerHTML = '';
      if (product.harga_normal) {
        const normalPrice = document.createElement('div');
        normalPrice.className = 'product-price-normal';
        normalPrice.textContent = `Rp ${parseInt(product.harga_normal).toLocaleString('id-ID')}`;
        prices.appendChild(normalPrice);
      }
      
      if (product.harga_promo) {
        const promoPrice = document.createElement('div');
        promoPrice.className = 'product-price-promo';
        promoPrice.textContent = `Rp ${parseInt(product.harga_promo).toLocaleString('id-ID')}`;
        prices.appendChild(promoPrice);
      } else if (product.harga_normal) {
        const onlyPrice = document.createElement('div');
        onlyPrice.className = 'product-price-only';
        onlyPrice.textContent = `Rp ${parseInt(product.harga_normal).toLocaleString('id-ID')}`;
        prices.appendChild(onlyPrice);
      }
      
      // Generate barcode jika tersedia
      if (product.barcode) {
        try {
          const canvas = document.getElementById('modalBarcodeCanvas');
          JsBarcode(canvas, product.barcode, {
            format: "CODE128",
            lineColor: "#000",
            width: 2,
            height: 60,
            displayValue: false
          });
        } catch (error) {
          console.error("Gagal membuat barcode:", error);
        }
      }
      
      // Tampilkan modal
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    // Fungsi untuk menutup modal
    function closeModal() {
      const modal = document.getElementById('productModal');
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }
    
    // Fungsi untuk memulai scanner barcode
    async function startScanner() {
      document.getElementById('scannerSection').style.display = 'block';
      
      try {
        // Inisialisasi scanner jika belum ada
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode("reader");
        }
        
        // Dapatkan daftar kamera
        const cameras = await Html5Qrcode.getCameras();
        
        if (cameras && cameras.length) {
          // Pilih kamera belakang jika tersedia
          const backCamera = cameras.find(camera => camera.label.toLowerCase().includes('back'));
          currentCameraId = backCamera ? backCamera.id : cameras[0].id;
          
          // Mulai scanner
          await html5QrCode.start(
            currentCameraId,
            {
              fps: 10,
              qrbox: { width: 250, height: 250 }
            },
            onScanSuccess,
            onScanFailure
          ).catch(err => {
            console.error("Gagal memulai scanner:", err);
          });
        } else {
          alert("Tidak ada kamera yang ditemukan!");
        }
      } catch (error) {
        console.error("Error saat memulai scanner:", error);
      }
    }
    
    // Fungsi untuk menangani hasil scan berhasil
    function onScanSuccess(decodedText, decodedResult) {
      // Hentikan scanner
      stopScanner();
      
      // Isi input pencarian dengan hasil scan
      document.getElementById('searchInput').value = decodedText;
      
      // Lakukan pencarian
      searchProducts();
    }
    
    // Fungsi untuk menangani hasil scan gagal
    function onScanFailure(error) {
      // Bisa diabaikan atau ditampilkan pesan error jika diperlukan
    }
    
    // Fungsi untuk menghentikan scanner
    function stopScanner() {
      if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
          document.getElementById('scannerSection').style.display = 'none';
        }).catch(err => {
          console.error("Gagal menghentikan scanner:", err);
        });
      } else {
        document.getElementById('scannerSection').style.display = 'none';
      }
    }
    
    // Fungsi untuk mengganti kamera
    async function switchCamera() {
      if (!html5QrCode || !html5QrCode.isScanning) return;
      
      try {
        // Dapatkan daftar kamera
        const cameras = await Html5Qrcode.getCameras();
        
        if (cameras.length <= 1) {
          alert("Hanya ada 1 kamera yang tersedia");
          return;
        }
        
        // Hentikan scanner
        await html5QrCode.stop();
        
        // Cari index kamera saat ini
        let currentIndex = cameras.findIndex(camera => camera.id === currentCameraId);
        
        // Pilih kamera berikutnya
        currentIndex = (currentIndex + 1) % cameras.length;
        currentCameraId = cameras[currentIndex].id;
        
        // Mulai scanner dengan kamera baru
        await html5QrCode.start(
          currentCameraId,
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          onScanSuccess,
          onScanFailure
        );
      } catch (error) {
        console.error("Gagal mengganti kamera:", error);
      }
    }
    
    // Fungsi untuk menginisialisasi peta
    function initMap() {
      // Inisialisasi peta dengan view ke Indonesia
      map = L.map('map').setView([-2.5489, 118.0149], 5);
      
      // Tambahkan tile layer (peta dasar)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Buat layer group untuk marker toko
      tokoLayerGroup = L.layerGroup().addTo(map);
    }
    
    // Fungsi untuk menampilkan marker toko di peta
    function renderTokoMarkers(tokoList) {
      // Hapus marker sebelumnya
      tokoLayerGroup.clearLayers();
      
      // Tambahkan marker untuk setiap toko
      tokoList.forEach(toko => {
        // Pastikan toko memiliki koordinat
        if (toko.latitude && toko.longitude) {
          const marker = L.marker([parseFloat(toko.latitude), parseFloat(toko.longitude)])
            .addTo(tokoLayerGroup)
            .bindPopup(`
              <div style="font-weight:bold;margin-bottom:8px;">${toko.nama_toko || 'Toko Indomaret'}</div>
              <div>${toko.alamat || 'Alamat tidak tersedia'}</div>
              <div style="margin-top:8px;font-size:0.9em;color:#666;">StoreCode: ${toko.store_code || 'N/A'}</div>
            `);
          
          tokoMarkers.push(marker);
        }
      });
      
      // Fit bounds untuk menampilkan semua marker
      if (tokoMarkers.length > 0) {
        const group = new L.featureGroup(tokoMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }
    
    // Fungsi untuk menampilkan daftar toko
    function renderTokoList(tokoList) {
      const mapsList = document.getElementById('mapsList');
      
      if (tokoList.length === 0) {
        mapsList.innerHTML = '<div class="no-products">Tidak ada toko ditemukan</div>';
        return;
      }
      
      mapsList.innerHTML = '';
      
      tokoList.forEach(toko => {
        const listItem = document.createElement('div');
        listItem.className = 'maps-list-item';
        listItem.innerHTML = `
          <div style="font-weight:bold;">${toko.nama_toko || 'Toko Indomaret'}</div>
          <div style="font-size:0.9em;color:var(--text-muted);">${toko.alamat || 'Alamat tidak tersedia'}</div>
          <div style="font-size:0.8em;color:var(--primary);margin-top:4px;">StoreCode: ${toko.store_code || 'N/A'}</div>
        `;
        
        // Zoom ke toko saat diklik
        listItem.addEventListener('click', () => {
          if (toko.latitude && toko.longitude) {
            map.setView([parseFloat(toko.latitude), parseFloat(toko.longitude)], 15);
            tokoLayerGroup.getLayers().forEach(layer => {
              if (layer.getLatLng().lat === parseFloat(toko.latitude) && 
                  layer.getLatLng().lng === parseFloat(toko.longitude)) {
                layer.openPopup();
              }
            });
          }
        });
        
        mapsList.appendChild(listItem);
      });
    }
    
    // Fungsi untuk mencari toko
    function searchToko() {
      const searchTerm = document.getElementById('mapsSearchInput').value.trim().toLowerCase();
      
      if (searchTerm === '') {
        renderTokoMarkers(tokoDatabase);
        renderTokoList(tokoDatabase);
        return;
      }
      
      // Filter toko berdasarkan kriteria pencarian
      const filteredToko = tokoDatabase.filter(toko => {
        return (
          (toko.store_code && toko.store_code.toLowerCase().includes(searchTerm)) ||
          (toko.nama_toko && toko.nama_toko.toLowerCase().includes(searchTerm)) ||
          (toko.alamat && toko.alamat.toLowerCase().includes(searchTerm))
        );
      });
      
      // Tampilkan hasil pencarian
      renderTokoMarkers(filteredToko);
      renderTokoList(filteredToko);
    }
    
    // Update jam real-time
    function updateClock() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('clock').textContent = `${hours}:${minutes}:${seconds}`;
    }
    setInterval(updateClock, 1000);
    updateClock();
  </script>
</body>
</html>
